{% extends "base.html" %}

{% block title %}Product Details - Product Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3"><i class="fas fa-eye"></i> Product Details</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('web.products') }}">Products</a></li>
                    <li class="breadcrumb-item active" id="productBreadcrumb">Loading...</li>
                </ol>
            </nav>
        </div>
        <div>
            <button class="btn btn-secondary me-2" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i> Back to Products
            </button>
            <button class="btn btn-primary" id="editProductBtn">
                <i class="fas fa-edit"></i> Edit Product
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-3">Loading product details...</p>
    </div>

    <!-- Product Details -->
    <div id="productDetails" class="d-none">
        <!-- Product Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div id="productImage" class="text-center mb-3">
                                    <div class="bg-light rounded p-4">
                                        <i class="fas fa-box fa-4x text-muted"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h2 id="productName" class="mb-2"></h2>
                                        <p id="productDescription" class="text-muted mb-3"></p>
                                    </div>
                                    <div class="col-md-4">
                                        <!-- Pricing Card -->
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="fas fa-dollar-sign"></i> Pricing</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-2">
                                                    <small class="text-muted d-block">Selling Price</small>
                                                    <span id="productPrice" class="fw-bold text-success"></span>
                                                </div>
                                                <div class="mb-2">
                                                    <small class="text-muted d-block">Cost Price</small>
                                                    <span id="productCostPrice">-</span>
                                                </div>
                                                <div class="mb-0">
                                                    <small class="text-muted d-block">Profit Margin</small>
                                                    <span id="productProfitMargin">-</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-3 mt-2">
                                    <div class="col-sm-6">
                                        <div class="border rounded p-3">
                                            <small class="text-muted d-block">SKU</small>
                                            <span id="productSku" class="fw-bold"></span>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="border rounded p-3">
                                            <small class="text-muted d-block">Barcode</small>
                                            <span id="productBarcode">-</span>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="border rounded p-3">
                                            <small class="text-muted d-block">Category</small>
                                            <span id="productCategory">-</span>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="border rounded p-3">
                                            <small class="text-muted d-block">Supplier</small>
                                            <span id="productSupplier">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Information and Stock Status -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Additional Information</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td class="text-muted">Weight</td>
                                    <td id="productWeight">-</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Dimensions</td>
                                    <td id="productDimensions">-</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Active</td>
                                    <td id="productIsActive">-</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Created</td>
                                    <td id="productCreatedAt">-</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Last Updated</td>
                                    <td id="productUpdatedAt">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <!-- Stock Status Card -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-warehouse"></i> Stock Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted d-block">Current Stock</small>
                            <span id="productStock" class="h4 fw-bold"></span>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted d-block">Reorder Level</small>
                            <span id="productReorderLevel">-</span>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted d-block">Status</small>
                            <span id="productStatus"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-2 col-sm-6">
                                <button id="editProductBtn" class="btn btn-primary w-100">
                                    <i class="fas fa-edit"></i> Edit Product
                                </button>
                            </div>
                            <div class="col-md-2 col-sm-6">
                                <button onclick="adjustStock()" class="btn btn-warning w-100">
                                    <i class="fas fa-boxes"></i> Adjust Stock
                                </button>
                            </div>
                            <div class="col-md-2 col-sm-6">
                                <button onclick="generateBarcode()" class="btn btn-info w-100">
                                    <i class="fas fa-barcode"></i> Generate Barcode
                                </button>
                            </div>
                            <div class="col-md-2 col-sm-6">
                                <button onclick="viewHistory()" class="btn btn-secondary w-100">
                                    <i class="fas fa-history"></i> View History
                                </button>
                            </div>
                            <div class="col-md-2 col-sm-6">
                                <button onclick="exportProduct()" class="btn btn-success w-100">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                            <div class="col-md-2 col-sm-6">
                                <button onclick="deleteProduct()" class="btn btn-danger w-100">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Get product ID from URL
const productId = {{ product_id }};

// Load product details
async function loadProductDetails() {
    try {
        const response = await apiRequest(`/products/${productId}`);

        if (response.success) {
            displayProductDetails(response.data);
        } else {
            showError('Product not found');
        }
    } catch (error) {
        showError('Error loading product details: ' + error.message);
    }
}

// Display product details
function displayProductDetails(product) {
    // Hide loading, show details
    document.getElementById('loadingState').classList.add('d-none');
    document.getElementById('productDetails').classList.remove('d-none');

    // Update breadcrumb
    document.getElementById('productBreadcrumb').textContent = product.product_name;

    // Basic info
    document.getElementById('productName').textContent = product.product_name;
    document.getElementById('productSku').textContent = product.sku;
    document.getElementById('productBarcode').textContent = product.barcode || '-';
    document.getElementById('productDescription').textContent = product.description || 'No description available';

    // Category and supplier
    document.getElementById('productCategory').textContent = product.category ? product.category.category_name : '-';
    document.getElementById('productSupplier').textContent = product.supplier ? product.supplier.supplier_name : '-';

    // Pricing
    document.getElementById('productPrice').textContent = formatCurrency(product.price);
    document.getElementById('productCostPrice').textContent = product.cost_price ? formatCurrency(product.cost_price) : '-';

    // Calculate profit margin
    if (product.cost_price && product.cost_price > 0) {
        const margin = ((product.price - product.cost_price) / product.cost_price * 100).toFixed(2);
        document.getElementById('productProfitMargin').textContent = margin + '%';
    } else {
        document.getElementById('productProfitMargin').textContent = '-';
    }

    // Stock info
    document.getElementById('productStock').textContent = product.quantity_in_stock;
    document.getElementById('productReorderLevel').textContent = product.reorder_level;

    // Status badge
    const statusElement = document.getElementById('productStatus');
    if (product.is_active) {
        if (product.quantity_in_stock <= product.reorder_level) {
            statusElement.innerHTML = '<span class="badge bg-warning">Low Stock</span>';
        } else {
            statusElement.innerHTML = '<span class="badge bg-success">Active</span>';
        }
    } else {
        statusElement.innerHTML = '<span class="badge bg-danger">Inactive</span>';
    }

    // Additional info
    document.getElementById('productWeight').textContent = product.weight ? product.weight + ' kg' : '-';
    document.getElementById('productDimensions').textContent = product.dimensions || '-';
    document.getElementById('productIsActive').textContent = product.is_active ? 'Yes' : 'No';
    document.getElementById('productCreatedAt').textContent = product.created_at ? formatDate(product.created_at) : '-';
    document.getElementById('productUpdatedAt').textContent = product.updated_at ? formatDate(product.updated_at) : '-';

    // Update stock color
    const stockElement = document.getElementById('productStock');
    if (product.quantity_in_stock <= product.reorder_level) {
        stockElement.classList.add('text-warning');
    } else {
        stockElement.classList.add('text-success');
    }
}

// Show error message
function showError(message) {
    document.getElementById('loadingState').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
        <a href="{{ url_for('web.products') }}" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> Back to Products
        </a>
    `;
}

// Edit product
function editProduct() {
    window.location.href = `{{ url_for('web.products') }}#edit-${productId}`;
}

// Quick actions (placeholders)
function adjustStock() {
    alert('Stock adjustment feature coming soon!');
}

function generateBarcode() {
    alert('Barcode generation feature coming soon!');
}

function viewHistory() {
    alert('Product history feature coming soon!');
}

function deleteProduct() {
    if (confirm('Are you sure you want to delete this product?')) {
        alert('Delete feature would be implemented here');
    }
}

function exportProduct() {
    alert('Export feature coming soon!');
}

// Format date helper
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadProductDetails();

    // Set up edit button
    document.getElementById('editProductBtn').addEventListener('click', editProduct);
});
</script>
{% endblock %}</content>
<parameter name="filePath">c:\Users\UTC\OneDrive\Desktop\FlaskProjectSCD\FlaskProjectSCD\templates\product_detail.html